<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* -------------------
         * Global Reset & Setup
         * ------------------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0e5ec; /* Background for desktop view */
            color: #1a202c;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* ------------------
         * Icon Styling
         * ------------------- */
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24;
            vertical-align: middle;
            font-size: 20px;
        }

        /* -------------------
         * App Layout
         * ------------------- */
        .app-container {
            width: 100%;
            min-height: 100vh; /* Use min-height for full screen */
            display: flex;
            flex-direction: column;
            background-color: #f4f7fa; 
            position: relative;
            overflow: hidden; /* Hide overflow */
        }

        .main-content {
            flex-grow: 1;
            overflow-y: auto; /* Allow content to scroll */
            padding: 24px 20px 100px 20px; /* Bottom padding to avoid nav overlap */
            scrollbar-width: none; 
            -ms-overflow-style: none; 
        }
        
        .main-content::-webkit-scrollbar { display: none; }
        
        /* General Card Style */
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 8px 24px rgba(149, 157, 165, 0.08);
            border: 1px solid #f1f1f1;
        }
        
        .card-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 16px;
            color: #475569;
        }
        
        .placeholder { color: #94a3b8; font-style: italic; }

        /* -------------------
         * Header (Student Profile)
         * ------------------- */
        header {
            margin-bottom: 24px;
            text-align: center;
        }

        header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            line-height: 1.2;
             min-height: 34px; /* Prevent jump */
        }

        header p {
            font-size: 16px;
            color: #718096;
            font-weight: 500;
             min-height: 24px; /* Prevent jump */
        }
        
        /* -------------------
         * Dashboard Stats Grid
         * ------------------- */
        .dash-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .stat-card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(149, 157, 165, 0.08);
            border: 1px solid #f1f1f1;
        }
        
        .stat-card-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 12px;
        }
        
        /* Icon Colors */
        .stat-card.attendance .material-symbols-outlined { color: #16a34a; }
        .stat-card.score .material-symbols-outlined { color: #4f46e5; }
        .stat-card.activities .material-symbols-outlined { color: #0ea5e9; }
        .stat-card.roles .material-symbols-outlined { color: #f59e0b; }
        
        .stat-card-main {
            font-size: 32px;
            font-weight: 700;
            color: #1a202c;
            line-height: 1.1;
            min-height: 35px; /* Prevent jump */
        }
        
        .stat-card-sub {
            font-size: 14px;
            color: #718096;
            font-weight: 500;
            margin-top: 4px;
            min-height: 21px; /* Prevent jump */
        }
        
        .badge-excel {
            display: inline-block;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 16px;
            background-color: #f0fdf4;
            color: #16a34a;
            margin-top: 8px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }
        
        .progress-bar .progress {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
        .stat-card.attendance .progress { background-color: #16a34a; }
        .stat-card.score .progress { background-color: #4f46e5; } /* Added */

        /* -------------------
         * Your Roles Card
         * ------------------- */
        #roles-container .tag { /* Targeting specific container */
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 16px;
            background-color: #eef2ff;
            color: #4338ca;
            display: inline-block;
            margin-right: 8px; /* Add spacing between multiple roles */
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        #roles-container .placeholder { /* Style for no roles */
             font-size: 14px;
        }
        
        /* -------------------
         * Score Breakdown Card
         * ------------------- */
         .breakdown-row {
             margin-bottom: 16px;
         }
         .breakdown-row:last-child {
             margin-bottom: 0;
         }
         
         .breakdown-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             font-size: 14px;
             margin-bottom: 8px;
         }
         
         .breakdown-label {
             font-weight: 500;
             color: #475569;
         }
         
         .breakdown-score {
             font-weight: 600;
             color: #1a202c;
             min-width: 40px; /* Prevent jump */
             text-align: right;
         }
         
         .breakdown-bar-bg {
            width: 100%;
            height: 10px;
            background-color: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
         }
         
         .breakdown-bar {
             height: 100%;
             border-radius: 5px;
             transition: width 0.5s ease-out;
         }
         
         /* Specific colors for breakdown bars */
         #breakdown-bar-lecture { background-color: #16a34a; } /* Green */
         #breakdown-bar-activity { background-color: #0ea5e9; } /* Blue */
         #breakdown-bar-role { background-color: #f59e0b; } /* Amber */
        
        /* -------------------
         * Bottom Navigation
         * ------------------- */
        .bottom-nav {
            position: absolute; 
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff; 
            display: flex;
            justify-content: space-around;
            padding: 12px 0 10px 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.06);
            border-top: 1px solid #e2e8f0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #718096; 
            font-size: 12px;
            font-weight: 500;
            flex: 1; 
        }
        .nav-item .material-symbols-outlined {
            font-size: 26px;
            margin-bottom: 2px;
        }
        .nav-item.active { color: #4f46e5; }
        .nav-item.active .material-symbols-outlined { font-variation-settings: 'FILL' 1; }
        
        
        /* -------------------
         * Desktop Media Query
         * ------------------- */
        @media (min-width: 500px) {
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 16px 0;
            }
            .app-container {
                max-width: 450px;
                height: 95vh;
                max-height: 850px;
                border-radius: 24px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
                border: 1px solid #f8f9fa;
            }
            .bottom-nav {
                border-bottom-left-radius: 24px;
                border-bottom-right-radius: 24px;
            }
        }

    </style>
</head>
<body>

    <div class="app-container">
        
        <main class="main-content">

            <header>
                <h1 id="student-name" class="placeholder">Loading...</h1>
                <p id="student-details" class="placeholder">Loading...</p>
            </header>

            <section class="dash-grid">
                <div class="stat-card attendance">
                    <div class="stat-card-header">
                        <span class="material-symbols-outlined">school</span>
                        Attendance
                    </div>
                    <div class="stat-card-main" id="stat-attendance-perc">--%</div>
                    <div class="progress-bar">
                        <div class="progress" id="stat-attendance-bar" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="stat-card score">
                    <div class="stat-card-header">
                        <span class="material-symbols-outlined">trending_up</span>
                        Total Score
                    </div>
                    <div class="stat-card-main" id="stat-total-score">--</div>
                    <div id="stat-score-badge"></div> 
                </div>
                
                <div class="stat-card activities">
                    <div class="stat-card-header">
                        <span class="material-symbols-outlined">calendar_month</span>
                        Activities
                    </div>
                    <div class="stat-card-main" id="stat-activity-count">--</div>
                    <div class="stat-card-sub" id="stat-activity-score">Score: --/--</div>
                </div>
                
                <div class="stat-card roles">
                    <div class="stat-card-header">
                        <span class="material-symbols-outlined">person</span>
                        Roles
                    </div>
                    <div class="stat-card-main" id="stat-roles-count">--</div>
                     <div class="stat-card-sub" id="stat-roles-score">Score: --/--</div>
                </div>
            </section>
            
            <div class="card roles-card">
                <div class="card-title">Your Roles</div>
                <div id="roles-container">
                    <p class="placeholder">Loading roles...</p>
                </div>
            </div>
            
            <div class="card breakdown-card">
                <div class="card-title">Score Breakdown</div>
                
                <div class="breakdown-row">
                    <div class="breakdown-header">
                        <span class="breakdown-label">Lecture Attendance (Max 50)</span>
                         <span class="breakdown-score" id="breakdown-score-lecture">--/50</span>
                    </div>
                    <div class="breakdown-bar-bg">
                         <div class="breakdown-bar" id="breakdown-bar-lecture" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="breakdown-row">
                    <div class="breakdown-header">
                        <span class="breakdown-label">Activities (Max 30)</span>
                         <span class="breakdown-score" id="breakdown-score-activity">--/30</span>
                    </div>
                    <div class="breakdown-bar-bg">
                         <div class="breakdown-bar" id="breakdown-bar-activity" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="breakdown-row light">
                    <div class="breakdown-header">
                        <span class="breakdown-label">Roles (Max 20)</span>
                         <span class="breakdown-score" id="breakdown-score-role">--/20</span>
                    </div>
                    <div class="breakdown-bar-bg">
                         <div class="breakdown-bar" id="breakdown-bar-role" style="width: 0%;"></div>
                    </div>
                </div>
                
            </div>
            
            <div style="height: 50px;"></div>

        </main>

        <nav class="bottom-nav">
            <a href="index.html" class="nav-item active"> <span class="material-symbols-outlined">dashboard</span>
                Dashboard
            </a>
            <a href="history.html" class="nav-item"> <span class="material-symbols-outlined">history</span>
                History
            </a>
        </nav>

    </div>

    <script>
        // --- 1. SUPABASE SETUP ---
        // ---- Main ClassCount Project ----
        const MAIN_SUPABASE_URL = 'https://qbtxcpyjceemqdqipcdd.supabase.co';
        const MAIN_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFidHhjcHlqY2VlbXFkcWlwY2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MjQ3ODYsImV4cCI6MjA3NzAwMDc4Nn0.xlYnj-EKqXcqFlYdx4Us1iEI2OoRV2IjtAyLIG6PVok';
        
        // ---- Student Authentication Project ----
        // TODO: Replace with your actual Student Auth Project URL and Key
        const AUTH_SUPABASE_URL = 'YOUR_STUDENT_AUTH_PROJECT_URL'; 
        const AUTH_SUPABASE_KEY = 'YOUR_STUDENT_AUTH_PROJECT_ANON_KEY';

        const { createClient } = supabase;
        const _supabaseMain = createClient(MAIN_SUPABASE_URL, MAIN_SUPABASE_KEY);
        const _supabaseAuth = createClient(AUTH_SUPABASE_URL, AUTH_SUPABASE_KEY);


        // --- 2. DOM ELEMENTS ---
        const studentNameEl = document.getElementById('student-name');
        const studentDetailsEl = document.getElementById('student-details');
        const statAttendancePerc = document.getElementById('stat-attendance-perc');
        const statAttendanceBar = document.getElementById('stat-attendance-bar');
        const statTotalScore = document.getElementById('stat-total-score');
        const statScoreBadge = document.getElementById('stat-score-badge');
        const statActivityCount = document.getElementById('stat-activity-count');
        const statActivityScore = document.getElementById('stat-activity-score');
        const statRolesCount = document.getElementById('stat-roles-count');
        const statRolesScore = document.getElementById('stat-roles-score');
        const rolesContainer = document.getElementById('roles-container');
        const breakdownScoreLecture = document.getElementById('breakdown-score-lecture');
        const breakdownBarLecture = document.getElementById('breakdown-bar-lecture');
        const breakdownScoreActivity = document.getElementById('breakdown-score-activity');
        const breakdownBarActivity = document.getElementById('breakdown-bar-activity');
        const breakdownScoreRole = document.getElementById('breakdown-score-role');
        const breakdownBarRole = document.getElementById('breakdown-bar-role');

        // --- 3. HELPER FUNCTIONS ---
        
        /**
         * Gets score level (for badge)
         */
        function getScoreLevel(score) {
             if (score >= 50) return { level: 'Excellent', class: 'badge-excel' }; // Updated threshold
             // Add more levels if needed
             return null; 
        }

        // --- 4. DATA LOADING & UI UPDATE ---

        /**
         * Main function to load all student dashboard data
         */
        async function loadStudentDashboard() {
            try {
                // 1. Get logged-in student user from Auth Project
                const { data: { user: authUser }, error: authError } = await _supabaseAuth.auth.getUser();
                if (authError || !authUser) {
                    throw new Error('Not logged in.');
                }

                // 2. Get student profile (id, course, role) from Auth Project's 'users' table
                // Assuming the user's auth ID matches the 'auth_id' column in your student 'users' table
                 const { data: studentAuthProfile, error: authProfileError } = await _supabaseAuth
                    .from('users') 
                    .select('id, course, role') // 'id' here is the student_id
                    .eq('auth_id', authUser.id) // Adjust if the linking column name is different
                    .single();

                if (authProfileError || !studentAuthProfile) {
                    console.error("Auth Profile Error:", authProfileError);
                    throw new Error('Student profile not found in auth database.');
                }
                
                const studentId = studentAuthProfile.id;
                const studentCourse = studentAuthProfile.course;
                const studentRole = studentAuthProfile.role; // Role from Auth Project


                // 3. Fetch data from Main Project using studentId
                const studentPromise = _supabaseMain.from('students').select('name, year').eq('student_id', studentId).single();
                const scorePromise = _supabaseMain.from('scores').select('*').eq('student_id', studentId).single();
                const summaryPromise = _supabaseMain.from('student_attendance_summary').select('lecture_percentage, event_present').eq('student_id', studentId).single();

                const [
                    { data: studentDetails, error: sErr },
                    { data: scores, error: scErr },
                    { data: summary, error: suErr }
                ] = await Promise.all([studentPromise, scorePromise, summaryPromise]);

                // Basic error check - more specific handling could be added
                if (sErr) throw new Error(`Could not fetch student details: ${sErr.message}`);
                // Note: Scores or summary might be null if no record exists yet, handle that gracefully

                const studentName = studentDetails?.name || 'Unknown Student';
                const studentYear = studentDetails?.year || '----';
                
                // Use fallback values (0) if score or summary data doesn't exist yet
                const lectureScore = scores?.lecture_score || 0;
                const activityScore = scores?.activity_score || 0;
                const roleScore = scores?.role_score || 0;
                const totalScore = scores?.total_score || 0;
                const lecturePercentage = summary?.lecture_percentage || 0;
                const activityCount = summary?.event_present || 0;
                const roleCount = (studentRole && studentRole.toLowerCase() !== 'student') ? 1 : 0; // Count only non-student roles

                // 4. Update Header
                studentNameEl.textContent = studentName;
                studentDetailsEl.textContent = `ID: ${studentId} • ${studentCourse.toUpperCase()} ${studentYear}`;
                studentNameEl.classList.remove('placeholder');
                studentDetailsEl.classList.remove('placeholder');


                // 5. Update Stat Cards
                statAttendancePerc.textContent = `${lecturePercentage.toFixed(0)}%`;
                statAttendanceBar.style.width = `${lecturePercentage}%`;
                
                statTotalScore.textContent = totalScore;
                const scoreLevel = getScoreLevel(totalScore);
                statScoreBadge.innerHTML = scoreLevel ? `<span class="${scoreLevel.class}">${scoreLevel.level}</span>` : '';

                statActivityCount.textContent = activityCount;
                statActivityScore.textContent = `Score: ${activityScore}/30`; // Max score hardcoded

                statRolesCount.textContent = roleCount;
                statRolesScore.textContent = `Score: ${roleScore}/20`; // Max score hardcoded

                // 6. Update Roles Card
                rolesContainer.innerHTML = ''; // Clear placeholder
                if (roleCount > 0) {
                     rolesContainer.innerHTML = `<div class="tag">${studentRole.toUpperCase()}</div>`;
                     // Add logic here if a student can have multiple roles
                } else {
                     rolesContainer.innerHTML = '<p class="placeholder">No specific roles assigned.</p>';
                }

                // 7. Update Score Breakdown
                breakdownScoreLecture.textContent = `${lectureScore}/50`; // Max score hardcoded
                breakdownBarLecture.style.width = `${(lectureScore / 50) * 100}%`; 
                
                breakdownScoreActivity.textContent = `${activityScore}/30`; // Max score hardcoded
                breakdownBarActivity.style.width = `${(activityScore / 30) * 100}%`; 

                breakdownScoreRole.textContent = `${roleScore}/20`; // Max score hardcoded
                breakdownBarRole.style.width = `${(roleScore / 20) * 100}%`; 


            } catch (error) {
                console.error("Error loading dashboard:", error);
                // Display error to user in the header
                studentNameEl.textContent = 'Error';
                studentDetailsEl.textContent = error.message;
                 studentNameEl.classList.remove('placeholder');
                 studentDetailsEl.classList.remove('placeholder');
                 // Optionally clear other fields or show 'N/A'
            }
        }


        // --- 5. RUN ON PAGE LOAD ---
        document.addEventListener('DOMContentLoaded', loadStudentDashboard);

    </script>

</body>
</html>
